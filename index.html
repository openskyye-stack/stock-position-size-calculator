<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Trading Calc II — Cash/Margin Toggle</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f1b2f;
      --panel-2: #0c172a;
      --border: rgba(255,255,255,0.10);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted-2: rgba(255,255,255,0.55);

      --accent: #f59e0b; /* orange */
      --accent-2: #22c55e; /* green */
      --danger: #ef4444; /* red */
      --shadow: 0 18px 45px rgba(0,0,0,0.35);

      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(245,158,11,0.22), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(34,197,94,0.16), transparent 45%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 26px;
    }

    .wrap{
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 18px;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .header{
      padding: 18px 18px 12px 18px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), transparent);
    }

    .title{
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title h1{
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .title p{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .content{
      padding: 18px;
    }

    .grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }

    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .field{
      background: rgba(15, 27, 47, 0.70);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }

    input, select{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
    }

    input::placeholder{ color: rgba(255,255,255,0.40); }

    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 14px;
    }

    .btn{
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .btn:hover{
      background: rgba(255,255,255,0.09);
    }

    .btn.primary{
      border-color: rgba(245,158,11,0.35);
      background: rgba(245,158,11,0.12);
    }

    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    /* Toggle */
    .toggle{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: rgba(15, 27, 47, 0.70);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
    }

    .toggle span{
      font-size: 12px;
      color: var(--muted);
      min-width: 46px;
      text-align: center;
    }

    .switch{
      position: relative;
      width: 56px;
      height: 28px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .switch::after{
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      transition: transform 160ms ease;
    }
    .switch.on{
      background: rgba(245,158,11,0.22);
      border-color: rgba(245,158,11,0.30);
    }
    .switch.on::after{
      transform: translateX(28px);
      background: rgba(255,255,255,0.95);
    }

    .results{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    .result{
      background: rgba(12, 23, 42, 0.65);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .result .k{
      font-size: 12px;
      color: var(--muted);
    }
    .result .v{
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .result .v.good{ color: var(--accent-2); }
    .result .v.warn{ color: var(--accent); }
    .result .v.bad{ color: var(--danger); }

    .note{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,0.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      background: rgba(255,255,255,0.03);
    }

    .explain{
      padding: 18px;
    }
    .explain h2{
      margin: 0 0 10px 0;
      font-size: 15px;
      letter-spacing: 0.2px;
    }
    .explain p{
      margin: 0 0 10px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .explain ul{
      margin: 10px 0 0 18px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .hr{
      height: 1px;
      background: var(--border);
      margin: 14px 0;
    }

    .foot{
      margin-top: 10px;
      color: var(--muted-2);
      font-size: 12px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(255,255,255,0.78);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Calculator -->
    <div class="card" role="region" aria-label="Cash and Margin calculator">
      <div class="header">
        <div class="title">
          <h1>Stock Trading Calc II — Cash/Margin</h1>
          <p>Computes buying power, risk-based shares, and a final recommended share size.</p>
        </div>

        <div class="toggle" aria-label="Cash/Margin toggle">
          <span id="modeLeft">Cash</span>
          <div id="modeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0" title="Toggle Cash/Margin"></div>
          <span id="modeRight">Margin</span>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="field">
            <label for="equity">Account Equity ($)</label>
            <input id="equity" inputmode="decimal" placeholder="0.00" value="0.00" />
          </div>

          <div class="field">
            <label for="riskPct">Risk Per Trade</label>
            <select id="riskPct">
              <option value="0.005">0.5%</option>
              <option value="0.01" selected>1%</option>
              <option value="0.02">2%</option>
            </select>
          </div>

          <div class="field">
            <label for="entry">Entry Price ($)</label>
            <input id="entry" inputmode="decimal" placeholder="0.00" value="0.00" />
          </div>

          <div class="field">
            <label for="stop">Stop Loss Price ($)</label>
            <input id="stop" inputmode="decimal" placeholder="0.00" value="0.00" />
          </div>

          <div class="field">
            <label for="cashLeverage">Cash Leverage (x)</label>
            <input id="cashLeverage" inputmode="decimal" placeholder="1.0" value="1.0" />
          </div>

          <div class="field">
            <label for="marginLeverage">Margin Leverage (x)</label>
            <input id="marginLeverage" inputmode="decimal" placeholder="2.0" value="2.0" />
          </div>

          <div class="field">
            <label for="maxBpPct">Max % of Buying Power to Use (optional)</label>
            <input id="maxBpPct" inputmode="decimal" placeholder="e.g., 100 = no cap" value="100" />
          </div>

          <div class="field">
            <label for="rounding">Share Rounding</label>
            <select id="rounding">
              <option value="floor" selected>Round Down (recommended)</option>
              <option value="nearest">Nearest Whole Share</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="calcBtn">Calculate</button>
          <button class="btn" id="resetBtn">Reset</button>
          <span class="badge" id="statusBadge">Mode: <strong id="modeLabel" style="color: rgba(255,255,255,0.88);">Cash</strong></span>
        </div>

        <div class="results" aria-label="Results">
          <div class="result">
            <div class="k">Buying Power</div>
            <div class="v" id="bp">$0.00</div>
          </div>
          <div class="result">
            <div class="k">Max Position Cost (cap applied)</div>
            <div class="v" id="maxCost">$0.00</div>
          </div>
          <div class="result">
            <div class="k">Risk $ (Equity × Risk %)</div>
            <div class="v" id="riskDollars">$0.00</div>
          </div>
          <div class="result">
            <div class="k">Risk per Share (|Entry − Stop|)</div>
            <div class="v" id="riskPerShare">$0.00</div>
          </div>
          <div class="result">
            <div class="k">Shares Allowed by Buying Power</div>
            <div class="v" id="sharesBp">0</div>
          </div>
          <div class="result">
            <div class="k">Shares Allowed by Risk</div>
            <div class="v" id="sharesRisk">0</div>
          </div>
          <div class="result">
            <div class="k">Recommended Shares (min of both)</div>
            <div class="v good" id="sharesFinal">0</div>
          </div>
        </div>

        <div class="note" id="messageBox" aria-live="polite">
          Enter values and click <strong>Calculate</strong>. If Entry equals Stop, risk-based sizing is not possible.
        </div>

        <div class="foot">
          Tip: This calculator assumes long positions. For shorts, the risk per share is still <span class="mono">abs(entry - stop)</span>.
        </div>
      </div>
    </div>

    <!-- Explanation Panel -->
    <div class="card">
      <div class="header">
        <div class="title">
          <h1>How this sizing works</h1>
          <p>What Cash vs Margin changes, and what the outputs mean.</p>
        </div>
      </div>

      <div class="explain">
        <h2>Cash vs Margin</h2>
        <p>
          The toggle changes your <strong>buying power</strong> by applying a leverage multiple to your account equity:
          <span class="mono">buyingPower = equity × leverage</span>.
          Cash defaults to <span class="mono">1.0×</span> and Margin defaults to <span class="mono">2.0×</span>, but you can edit both.
        </p>

        <div class="hr"></div>

        <h2>Position sizing logic</h2>
        <ul>
          <li><strong>Risk dollars</strong> = equity × risk% (0.5%, 1%, or 2%).</li>
          <li><strong>Risk per share</strong> = |entry − stop|.</li>
          <li><strong>Risk-based shares</strong> = risk$ ÷ riskPerShare.</li>
          <li><strong>Buying-power shares</strong> = maxPositionCost ÷ entry.</li>
          <li><strong>Recommended shares</strong> = min(risk-based shares, buying-power shares).</li>
        </ul>

        <div class="hr"></div>

        <h2>Max % of Buying Power (optional cap)</h2>
        <p>
          If you set this to 100, you’re allowing the calculator to use up to 100% of buying power.
          If you set it to 30, the calculator will cap the position to 30% of buying power before shares are computed.
        </p>

        <div class="foot">
          If you want margin rules to reflect your broker’s specific intraday/overnight leverage, update the leverage fields accordingly.
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      const equityEl = $("equity");
      const riskPctEl = $("riskPct");
      const entryEl = $("entry");
      const stopEl  = $("stop");
      const cashLevEl = $("cashLeverage");
      const marginLevEl = $("marginLeverage");
      const maxBpPctEl = $("maxBpPct");
      const roundingEl = $("rounding");

      const modeSwitch = $("modeSwitch");
      const modeLabel = $("modeLabel");
      const statusBadge = $("statusBadge");

      const bpOut = $("bp");
      const maxCostOut = $("maxCost");
      const riskDollarsOut = $("riskDollars");
      const riskPerShareOut = $("riskPerShare");
      const sharesBpOut = $("sharesBp");
      const sharesRiskOut = $("sharesRisk");
      const sharesFinalOut = $("sharesFinal");
      const messageBox = $("messageBox");

      const calcBtn = $("calcBtn");
      const resetBtn = $("resetBtn");

      // Mode: false = Cash, true = Margin
      let isMargin = false;

      function toNum(v){
        const n = Number(String(v).replace(/,/g,"").trim());
        return Number.isFinite(n) ? n : NaN;
      }

      function money(n){
        if(!Number.isFinite(n)) return "$0.00";
        return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
      }

      function whole(n, mode){
        if(!Number.isFinite(n)) return 0;
        if(mode === "nearest") return Math.max(0, Math.round(n));
        return Math.max(0, Math.floor(n));
      }

      function setMessage(text, level){
        // level: "info" | "warn" | "bad"
        messageBox.textContent = text;
        messageBox.style.borderColor =
          level === "bad" ? "rgba(239,68,68,0.55)" :
          level === "warn" ? "rgba(245,158,11,0.55)" :
          "rgba(255,255,255,0.18)";
        messageBox.style.background =
          level === "bad" ? "rgba(239,68,68,0.08)" :
          level === "warn" ? "rgba(245,158,11,0.07)" :
          "rgba(255,255,255,0.03)";
      }

      function setMode(marginOn){
        isMargin = !!marginOn;
        modeSwitch.classList.toggle("on", isMargin);
        modeSwitch.setAttribute("aria-checked", isMargin ? "true" : "false");
        modeLabel.textContent = isMargin ? "Margin" : "Cash";
      }

      function calculate(){
        const equity = toNum(equityEl.value);
        const riskPct = toNum(riskPctEl.value);
        const entry = toNum(entryEl.value);
        const stop = toNum(stopEl.value);
        const cashLev = toNum(cashLevEl.value);
        const marginLev = toNum(marginLevEl.value);
        const maxBpPct = toNum(maxBpPctEl.value);
        const roundingMode = roundingEl.value;

        // Basic validation
        if(!Number.isFinite(equity) || equity <= 0){
          setMessage("Account Equity must be greater than 0.", "bad");
          return renderZeros();
        }
        if(!Number.isFinite(entry) || entry <= 0){
          setMessage("Entry Price must be greater than 0.", "bad");
          return renderZeros();
        }
        if(!Number.isFinite(stop) || stop <= 0){
          setMessage("Stop Loss Price must be greater than 0.", "bad");
          return renderZeros();
        }
        if(!Number.isFinite(riskPct) || riskPct <= 0){
          setMessage("Risk % must be selected.", "bad");
          return renderZeros();
        }

        const lev = isMargin ? marginLev : cashLev;
        if(!Number.isFinite(lev) || lev <= 0){
          setMessage("Leverage must be greater than 0.", "bad");
          return renderZeros();
        }

        // Buying Power
        const buyingPower = equity * lev;

        // Optional max BP cap
        let capPct = 100;
        if(Number.isFinite(maxBpPct)){
          capPct = Math.max(0, maxBpPct);
        }
        const maxPositionCost = buyingPower * (capPct / 100);

        // Risk sizing
        const riskDollars = equity * riskPct;
        const rps = Math.abs(entry - stop);

        // Outputs (always show these)
        bpOut.textContent = money(buyingPower);
        maxCostOut.textContent = money(maxPositionCost);
        riskDollarsOut.textContent = money(riskDollars);
        riskPerShareOut.textContent = money(rps);

        if(rps === 0){
          sharesBpOut.textContent = String(whole(maxPositionCost / entry, roundingMode));
          sharesRiskOut.textContent = "0";
          sharesFinalOut.textContent = "0";
          sharesFinalOut.className = "v bad";
          setMessage("Entry equals Stop, so risk per share is $0.00. Adjust Stop Loss to calculate risk-based shares.", "bad");
          return;
        }

        const sharesByBP = maxPositionCost / entry;
        const sharesByRisk = riskDollars / rps;

        const sBP = whole(sharesByBP, roundingMode);
        const sRisk = whole(sharesByRisk, roundingMode);
        const sFinal = Math.min(sBP, sRisk);

        sharesBpOut.textContent = String(sBP);
        sharesRiskOut.textContent = String(sRisk);
        sharesFinalOut.textContent = String(sFinal);

        // Message + color logic
        if(sFinal <= 0){
          sharesFinalOut.className = "v bad";
          setMessage("No valid share size found with these inputs (check Entry/Stop distance and caps).", "bad");
          return;
        }

        // If buying power constraint is the limiter
        if(sBP < sRisk){
          sharesFinalOut.className = "v warn";
          setMessage("Recommended shares are limited by buying power/cap (not by risk).", "warn");
          return;
        }

        sharesFinalOut.className = "v good";
        setMessage("Recommended shares are limited by your risk settings (as intended).", "info");
      }

      function renderZeros(){
        bpOut.textContent = "$0.00";
        maxCostOut.textContent = "$0.00";
        riskDollarsOut.textContent = "$0.00";
        riskPerShareOut.textContent = "$0.00";
        sharesBpOut.textContent = "0";
        sharesRiskOut.textContent = "0";
        sharesFinalOut.textContent = "0";
        sharesFinalOut.className = "v good";
      }

      function reset(){
        equityEl.value = "0.00";
        riskPctEl.value = "0.01";
        entryEl.value = "0.00";
        stopEl.value = "0.00";
        cashLevEl.value = "1.0";
        marginLevEl.value = "2.0";
        maxBpPctEl.value = "100";
        roundingEl.value = "floor";
        setMode(false);
        renderZeros();
        setMessage("Enter values and click Calculate. If Entry equals Stop, risk-based sizing is not possible.", "info");
      }

      // Toggle interactions
      modeSwitch.addEventListener("click", () => {
        setMode(!isMargin);
        calculate(); // live refresh
      });

      modeSwitch.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          setMode(!isMargin);
          calculate();
        }
      });

      // Buttons
      calcBtn.addEventListener("click", calculate);
      resetBtn.addEventListener("click", reset);

      // Auto-calc on input change (safe + reduces “why didn’t it update?”)
      const inputs = [equityEl, riskPctEl, entryEl, stopEl, cashLevEl, marginLevEl, maxBpPctEl, roundingEl];
      inputs.forEach(el => el.addEventListener("input", () => {
        // only auto-calc if user started entering meaningful values
        calculate();
      }));

      // Initialize
      reset();
    })();
  </script>
</body>
</html>
